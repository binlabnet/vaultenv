---
version: "v1.0"
name: "Semaphore pipeline for Sharkmachine"

agent:
  machine:
    type: "e1-standard-8"
    os_image: "ubuntu1804"

blocks:
  - name: "linux: build and test"
    dependencies: []

    task:
      secrets:
        # Contains CACHIX_SIGNING_KEY, which we need to upload new cache
        # entries to Cachix, the Nix cache as a service.
        - name: "cachix-channable-public"
      jobs:
        - name: "linux: build and test"
          commands:
            # Get the code.
            - "checkout"

            # Install Nix using the vendored installation script. Afterwards,
            # everything can run through the Nix kmanaged environment as long
            # as the commands are prefixed with `nix run -c`.
            - "./nix/install-nix.sh"
            - "source $HOME/.nix-profile/etc/profile.d/nix.sh"

            # Use our own public Cachix cache. Everyone can see/download stuff
            # from here. Take care with what you upload.
            - "nix run -c cachix use static-haskell-nix"
            - "nix run -c cachix use channable-public"

            # TODO: Find out a way to background this so we upload  *all* Nix
            # builds to the cachix store instead of just the vaultenv closure.
            # (Otherwise we rebuild Cabal and build tools on every CI run).
            # - "nix run -c cachix push -w channable-public

            # Build the static binary. Upload the results to the cache. See
            # `nix/vaultenv-static.nix` for documentation on this invocation
            # and what the script does. The `| cachix upload` ensures that
            # we upload all new artifacts to our Cachix cache after we're
            # done.
            - "$(nix-build --no-link -A full-build-script nix/vaultenv-static.nix) | nix run -c cachix push channable-public"

      agent:
        machine:
          type: "e1-standard-8"
          os_image: "ubuntu1804"

   - name: "mac: build and test"
     dependencies: []

     task:
       jobs:
         - name: "mac: build and test"
           commands:

            # Get the code.
            - "checkout"

            # Install Nix using the vendored installation script. Afterwards,
            # everything can run through the Nix kmanaged environment as long
            # as the commands are prefixed with `nix run -c`.
            - "./nix/install-nix.sh"
            - "source $HOME/.nix-profile/etc/profile.d/nix.sh"

            # We don't attempt to build a fully static binary on OS X. Instead
            # we just build a normal one with the `stack` from `default.nix`.
            - "nix run -c stack build"

       agent:
         machine:
           type: "a1-standard-4"
